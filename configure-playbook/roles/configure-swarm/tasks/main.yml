---

- name: Initialize swarm
  delegate_to: "{{ ansible_play_hosts_all[0] }}"
  community.docker.docker_swarm:
    state: present
  register: swarm_data
  when: ansible_play_hosts_all.index(inventory_hostname) == 0
    
- name: Set join token
  ansible.builtin.set_fact:
    join_token: "{{ swarm_data.swarm_facts.JoinTokens.Manager }}"
  delegate_to: "{{ item }}"
  delegate_facts: true
  loop: "{{ ansible_play_hosts_all }} "
  when: ansible_play_hosts_all.index(inventory_hostname) == 0

- debug:
    msg: "{{ join_token }}"
- debug:
    msg: "{{ lookup('community.general.dig', inventory_hostname) }}"
- debug:
    msg: "{{ lookup('community.general.dig', ansible_play_hosts_all[0]) }}"

- name: Join swarm
  community.docker.docker_swarm:
    state: join
    advertise_addr: "{{ lookup('community.general.dig', inventory_hostname) }}"
    join_token: "{{ join_token }}"
    remote_addrs: [ "{{ lookup('community.general.dig', ansible_play_hosts_all[0]) }}:2337" ]
  when: ansible_play_hosts_all.index(inventory_hostname) != 0
