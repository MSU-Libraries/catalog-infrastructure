---

- name: Initialize swarm
  delegate_to: "{{ ansible_play_hosts_all[0] }}"
  community.docker.docker_swarm:
    state: present
  register: swarm_data
  when: ansible_play_hosts_all.index(inventory_hostname) == 0

- name: Set join token
  ansible.builtin.set_fact:
    join_token: "{{ swarm_data.swarm_facts.JoinTokens.Manager }}"
  delegate_to: localhost
  delegate_facts: true
  when: ansible_play_hosts_all.index(inventory_hostname) == 0

- name: Propogate join token
  ansible.builtin.set_fact:
      join_token: "{{ join_token }}"
  delegate_to: "{{ item }}"
  delegate_facts: true
  loop: "{{ ansible_play_hosts_all }} "

- debug:
    msg: "{{ lookup(inventory_hostname[0]) }}"

- debug:
    msg: "{{ join_token }}"

#- name: Join swarm
#  community.docker.docker_swarm:
#    state: join
#    advertise_addr: "{{ lookup(inventory_hostname[0]) }}"
#    join_token: "{{ swarm_data.swarm_facts.JoinTokens.Manager }}"
#    remote_addrs: [ '' ]
#  when: {{ ansible_play_hosts_all.index(inventory_hostname) != 0 }}
