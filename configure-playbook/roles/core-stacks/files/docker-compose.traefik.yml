---
version: "3.8"
services:
  traefik:
    image: traefik:v2.11
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik:/etc/traefik
      - logs:/mnt/logs
    networks:
      - public
    ports:
      - target: 80
        published: 80
        protocol: tcp
        mode: host
      - target: 443
        published: 443
        protocol: tcp
        mode: host
    environment:
      # XXX: The environment will be replaced by traefik-env.yml during deploy
    command:
      - "--providers.docker"
      - "--providers.docker.swarmMode=true"
      - "--providers.docker.exposedByDefault=false"
      - "--providers.docker.network=public"
      - '--providers.docker.defaultRule=Host(`{{ index .Labels "com.docker.stack.namespace" | trimSuffix "-catalog" }}.aws.lib.msu.edu`)'
      - "--entrypoints.msul-http-ent.address=:80"
      - "--entrypoints.msul-http-ent.transport.respondingTimeouts.readTimeout=60s"
      - "--entrypoints.msul-http-ent.http.redirections.entryPoint.to=msul-https-ent"
      - "--entrypoints.msul-http-ent.http.redirections.entryPoint.scheme=https"
      - "--entrypoints.msul-https-ent.address=:443"
      - "--entrypoints.msul-https-ent.transport.respondingTimeouts.readTimeout=60s"
      - "--entryPoints.msul-https-ent.forwardedHeaders.trustedIPs=10.0.0.0/16"
      - "--log"
      - "--log.level=ERROR"
      - "--log.filepath=/mnt/logs/traefik.log"
      - "--accesslog"
      - "--accesslog.filepath=/mnt/logs/access.log"
      - "--accesslog.fields.headers.names.User-Agent=keep"
      - "--accesslog.fields.names.ClientHost=drop"
      - "--api.dashboard=true"
      #- "--api.debug=true"     # Enable this line to use Traefik's /debug
      - "--entrypoints.health-ent.address=:8081"
      - "--ping"
      - "--ping.entrypoint=health-ent"
      - "--global.checknewversion=false"
      - "--global.sendanonymoususage=false"
      - "--certificatesresolvers.msul-letsencrypt.acme.email=LIB.DL.DDaS@msu.edu"
      - "--certificatesresolvers.msul-letsencrypt.acme.storage=/etc/traefik/acme.json"
      - "--certificatesresolvers.msul-letsencrypt.acme.httpchallenge=true"
      - "--certificatesresolvers.msul-letsencrypt.acme.httpchallenge.entrypoint=msul-http-ent"
      - "--certificatesresolvers.msul-letsencrypt-dns.acme.email=LIB.DL.DDaS@msu.edu"
      - "--certificatesresolvers.msul-letsencrypt-dns.acme.storage=/etc/traefik/acme-dns.json"
      - "--certificatesresolvers.msul-letsencrypt-dns.acme.dnschallenge=true"
      - "--certificatesresolvers.msul-letsencrypt-dns.acme.dnschallenge.provider=route53"
    healthcheck:
      test: >
        traefik healthcheck \
          --entrypoints.health-ent.address=127.0.0.1:8081 \
          --ping \
          --ping.entrypoint=health-ent
      interval: 30s
      timeout: 5s
      retries: 1
      start_period: 20s
    logging:
      driver: "json-file"
      options:
        max-file: "5"
        max-size: "10m"
    deploy:
      mode: global
      placement:
        max_replicas_per_node: 1
      update_config:
        parallelism: 1
        failure_action: rollback
      restart_policy:
        window: 15s
      resources:
        limits:
          cpus: '1'
          memory: 300M
      labels:
        - "traefik.enable=true"
        - "traefik.http.services.traefik-public-traefik.loadbalancer.server.port=9999"
        # BasicAuth Middleware for restricted resources
        - "traefik.http.middlewares.restrict-auth.basicauth.users=${BASICAUTH_FOR_RESOURCES}"
        # Redirect Middleware (TODO Deprecated - Traefik now configured to always redirect HTTP)
        - "traefik.http.middlewares.http-redirect.redirectscheme.scheme=https"
        - "traefik.http.middlewares.http-redirect.redirectscheme.permanent=true"
        # Middleware to add /vufind to path
        - "traefik.http.middlewares.fix-prefix.replacepathregex.regex=^/(vufind/)?(.*)"
        - "traefik.http.middlewares.fix-prefix.replacepathregex.replacement=/vufind/$$2"
        - "traefik.http.middlewares.saml-prefix.replacepathregex.regex=^/vufind/simplesamlphp/(.*)"
        - "traefik.http.middlewares.saml-prefix.replacepathregex.replacement=/simplesamlphp/$$1"
        # Redirect to remove /vufind prefix
        - "traefik.http.middlewares.remove-prefix.redirectregex.regex=^(https://[^/]+)/vufind(/.*)"
        - "traefik.http.middlewares.remove-prefix.redirectregex.replacement=$${1}$${2}"
        - "traefik.http.middlewares.remove-prefix.redirectregex.permanent=true"
        # IP restrictions middleware
        - "traefik.http.middlewares.ip-campus.ipallowlist.sourcerange=35.8.0.0/13,35.20.0.0/14"
        # Emergency brakes on overload situation
        # - median request time over 60 seconds (all requests, not just VuFind pages)
        # - 50% or higher network failure (e.g. timeout or dropped packet)
        - "traefik.http.middlewares.emergency-brakes.circuitbreaker.expression=\
          LatencyAtQuantileMS(50.0) > 60000 \
          || NetworkErrorRatio() > 0.50"
        - "traefik.http.middlewares.emergency-brakes.circuitbreaker.checkperiod=15s"
        - "traefik.http.middlewares.emergency-brakes.circuitbreaker.fallbackduration=15s"
        - "traefik.http.middlewares.emergency-brakes.circuitbreaker.recoveryduration=15s"
        # Traefik Dashboard HTTPS
        - "traefik.http.routers.dashboard-https-router.entrypoints=msul-https-ent"
        - "traefik.http.routers.dashboard-https-router.middlewares=restrict-auth"
        - "traefik.http.routers.dashboard-https-router.tls=true"
        - "traefik.http.routers.dashboard-https-router.tls.certresolver=msul-letsencrypt-dns"
        - "traefik.http.routers.dashboard-https-router.rule=\
            Host(`${DEPLOY_HOST_1}`,`${DEPLOY_HOST_2}`,`${DEPLOY_HOST_3}`) && \
            (PathPrefix(`/dashboard`) || PathPrefix(`/api`) || PathPrefix(`/debug`))"
        - "traefik.http.routers.dashboard-https-router.service=api@internal"

networks:
  public:
    name: public
    external: true

volumes:
  traefik:
    driver: local
  logs:
    external: true
    name: "traefik_logs"
