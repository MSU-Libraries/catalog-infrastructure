
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="../mannually-run-terraform-commands/">
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>First Time Setup - MSU Libraries Public Catalog Infrastructure Technical Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#first-time-setup" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="MSU Libraries Public Catalog Infrastructure Technical Documentation" class="md-header__button md-logo" aria-label="MSU Libraries Public Catalog Infrastructure Technical Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            MSU Libraries Public Catalog Infrastructure Technical Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              First Time Setup
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/MSU-Libraries/catalog-infrastructure" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    MSU-Libraries/catalog-infrastructure
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="MSU Libraries Public Catalog Infrastructure Technical Documentation" class="md-nav__button md-logo" aria-label="MSU Libraries Public Catalog Infrastructure Technical Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    MSU Libraries Public Catalog Infrastructure Technical Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/MSU-Libraries/catalog-infrastructure" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    MSU-Libraries/catalog-infrastructure
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Welcome
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    First Time Setup
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    First Time Setup
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#aws-user-setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        AWS User Setup
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gitlab-setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        GitLab Setup
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GitLab Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#msul-users" class="md-nav__link">
    <span class="md-ellipsis">
      
        MSUL Users
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-user-setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Deploy User Setup
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#terraform-setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Terraform Setup
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dns-setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        DNS Setup
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    How To Guides
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    How To Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mannually-run-terraform-commands/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Manually run terraform commands
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../increasing-node-root-partition-size/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Increasing node root partition size
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../force-recreation-of-a-node/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Force recreation of a node
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mounting-the-shared-storage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mounting the shared storage
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Troubleshooting
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Troubleshooting
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../traefik-lets-encrypt-certificates-not-renewing-automatically/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Traefik Let's Encrypt certificates not renewing automatically
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Developing
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Developing
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documentation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Documentation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#aws-user-setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        AWS User Setup
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gitlab-setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        GitLab Setup
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GitLab Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#msul-users" class="md-nav__link">
    <span class="md-ellipsis">
      
        MSUL Users
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-user-setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Deploy User Setup
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#terraform-setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Terraform Setup
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dns-setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        DNS Setup
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="first-time-setup">First time setup</h1>
<h2 id="aws-user-setup">AWS User Setup</h2>
<p>An AWS user is required and will need to have multiple access roles granted to it in IAM
to perform the tasks required in Terraform. Below outline the permissions required on the group
the AWS user is attached to:  </p>
<p>Policy: <code>AmazonEC2FullAccess</code><br />
<a href="https://github.com/MSU-Libraries/catalog-infrastructure/blob/main/user-policy.json">Custom Policy</a></p>
<p>If you are using the above IAM policy as a template for yourself, be sure to modify any IDs
or resource names as needed (some are specifically named <code>msul</code>).  </p>
<p>Save the AWS Key and Secret for this user to be set in the GitLab CI/CD variables.</p>
<h2 id="gitlab-setup">GitLab Setup</h2>
<p>GitLab is not required for using this repository -- it simply helps call all of the steps in
the correct order with the right parameters. If you want to use this repository without
GitLab you can still references the <code>.gitlab-ci.yml</code> file to help understand what steps
you would need to manually run in order to spin up your cluster(s). Like how to use the
below variables that would be in the CI/CD settings.</p>
<p>The following CI/CD variables must also be created: (note that GitLab supports defining different values for the same variable for
each environment, so you can have a <code>DEPLOY_HOST_1,2,3</code> for devel and different values for prod (and different values of
the <code>MAIN_TF_FILE</code> for shared).</p>
<ul>
<li><code>AWS_KEY</code>: The AWS Key for the user with the above user-policy</li>
<li><code>AWS_SECRET</code>: The AWS Secret for the user with the above user-policy</li>
<li><code>ROOT_PRIVATE_KEY</code>: This is the <code>base64</code> encoded private key, the public key is in the Terraform environment definititions</li>
<li><code>DEPLOY_HOST_1</code>: The first node in the cluster (i.e. catprod-1.aws.lib.msu.edu)</li>
<li><code>DEPLOY_HOST_2</code>: The second node in the cluster</li>
<li><code>DEPLOY_HOST_3</code>: The third node in the cluster</li>
<li><code>GITHUB_USER_TOKEN</code>: Token used to publish releases to GitHub repository</li>
<li><code>VARIABLES_YAML_FILE</code>:  Containing the completed contents of the  <code>configure-playbook/variables.yml.example</code>
  file leaving in <code>$</code> variable references like <code>REGISTRY_ACCESS_TOKEN</code>. Concentrate on completeing the
  <code>create_users</code> section with all the users that should have access to the nodes and their <code>public_keys</code> they will use.</li>
<li><code>MAIN_TF_FILE</code>: Containing the completed contents of <code>terraform/env/{devel,prod,shared}/main.tf.example</code> (remember, this can be a scoped variable)</li>
<li><code>RW_CICD_TOKEN</code>: Read-Write access token to this repository used to create release tags</li>
</ul>
<h3 id="msul-users">MSUL Users</h3>
<p>The user running the pipeline needs to have access to read from the following repositories:</p>
<ul>
<li>(optional) <a href="https://gitlab.msu.edu/msu-libraries/devops/playbook-ubuntu-setup">playbook-ubuntu-setup</a><ul>
<li>This is an optional stage in the pipleine and not required.</li>
<li>This requires the public key for the <code>ROOT_PRIVATE_KEY</code> to be manually added to the
  <code>ubuntusetup</code> user's authorized keys file on the <code>ansible.lib.msu.edu</code> server for the CI to connect.</li>
<li>The CI will connect with that key but then from the <code>ansible.lib.msu.edu</code> server it will connect
  to the catalog nodes as the <code>ansible</code> user using the key created in the <code>user_data.sh</code> script in Terraform
  (the public key is passed in via the Terraform environment definitions and the private key is stored only
  on the <code>ansible.lib.msu.edu</code> server in the <code>ansible</code> user's <code>.ssh</code> directory.</li>
</ul>
</li>
</ul>
<h2 id="deploy-user-setup">Deploy User Setup</h2>
<p>A deploy key has been created and it's public key is stored in the <code>configure-playbook/variables.yml</code> CI variable, <code>VARIABLE_YAML_FILE</code> with
a corresponding private key in the CI/CD variables of the
<a href="https://gitlab.msu.edu/msu-libraries/catalog/catalog/-/settings/ci_cd">catalog project's repository</a>. Should that key ever need to change,
both locations will need to be updated in the <code>DEPLOY_PRIVATE_KEY</code> variable there.</p>
<p>This key is used in this repository when
the <code>configure-playbook</code> is run and is setting up users; it will setup the authorized key entry for that public key
on the <code>deploy</code> user. Then the <a href="https://github.com/MSU-Libraries/catalog">catalog repository</a> uses that when
it connects to the codes as the deploy user to deploy the Docker stacks.</p>
<h2 id="terraform-setup">Terraform Setup</h2>
<p>This repository contains 3 Terraform environments: shared, devel, and prod. The shared one represents
shared resources accross all the clusters, such as the storage. Those resources must be created first before
either devel or prod are created.</p>
<p>The 3 environments we have created in this repository represent specific settings that made sense for us.
To make your own cluster, you will want to copy the shared environment and the devel and/or prod directories
and start modifying them. Here are the values you are most likely going to want to change in each:</p>
<p><strong>Shared</strong></p>
<ul>
<li><code>terraform</code><ul>
<li><code>backend "s3"</code>: This identifies where the Terraform state file is stored, you'll want to make this a
bucket and key specific to you</li>
</ul>
</li>
<li><code>module "shared"</code><ul>
<li><code>alert_emails</code>: What distribution list will receive alert emails from AWS</li>
<li><code>domain</code>: The domain to create the resources in</li>
<li><code>zone_id</code>: The DNS zone ID in Route53 that the <code>domain</code> is associated with</li>
</ul>
</li>
<li><code>module "cluster"</code><ul>
<li><code>root_public_key</code>: Public SSH key for the root user on the nodes created earlier in the <code>ROOT_PRIVATE_KEY</code></li>
<li><code>ansible_public_key</code>: Public SSH key for the ansible server that will run ubuntu-setup-playbook.
  This is MSUL specific and should be left blank for other users.</li>
<li><code>net_allow_inbound_ssh</code>: CIDR range that allows connections from port 22 (ssh)</li>
<li><code>net_allow_inbound_ncpa</code>: CIDR range that allows connections from port 5693 (for Nagios NCPA monitoring)</li>
<li><code>net_allow_inbound_web</code>: CIDR range that allows connections from port 443 and 80</li>
<li><code>roundrobin_hostnames</code>: DNS names that you want created to resolve to one of the 3 nodes in the cluster</li>
<li><code>nodes</code><ul>
<li><code>server_name</code>: Name of the server in the cluster</li>
<li><code>aws_ami</code>: The AWS AMI for the instance you want to create (this is like the VM image tag)</li>
<li><code>aws_instance_type</code>: Type of EC2 instance to create</li>
<li><code>aws_root_block_size</code>: Size of the root partition of the node</li>
<li><code>cpu_balance_threshold</code>: What CPU credit balance threshold must be met for an alert to be sent</li>
<li><code>ebs_balance_threshold</code>: What percentage threshold of the burst balance for an alert to be sent</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Also of note, we have two cases where we have <code>prevent_destroy</code> set to avoid accidently destroying critical
resources (our EFS share and the EC2 instances), such as a bad commit in a CI deploy. But if you are testing
and want to be able to remove those, you will need to look for those references and set it to <code>false</code>.</p>
<h2 id="dns-setup">DNS Setup</h2>
<p>Since this terraform playbook only creates DNS entries in the <code>.aws.lib.msu.edu</code>
domain (see the <code>domain</code> variable in the terraform files), and we want our site
to be accessible at <code>catalog.lib.msu.edu</code> (and not just <code>catalog.aws.lib.msu.edu</code>), we need to create CNAME
entries in our local DNS server that point to the ones that AWS created.</p>
<p>For example, we have the following CNAME records:</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Target</th>
</tr>
</thead>
<tbody>
<tr>
<td>catalog</td>
<td>Alias (CNAME)</td>
<td>catprod.aws.lib.msu.edu.</td>
</tr>
<tr>
<td>catalog-beta</td>
<td>Alias (CNAME)</td>
<td>catprod.aws.lib.msu.edu.</td>
</tr>
<tr>
<td>catalog-preview</td>
<td>Alias (CNAME)</td>
<td>catprod.aws.lib.msu.edu.</td>
</tr>
<tr>
<td>catalog-prod</td>
<td>Alias (CNAME)</td>
<td>catprod.aws.lib.msu.edu.</td>
</tr>
</tbody>
</table>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.expand", "navigation.instant"], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="https://unpkg.com/tablesort@5.3.0/dist/tablesort.min.js"></script>
      
        <script src="../javascripts/tablesort.js"></script>
      
    
  </body>
</html>