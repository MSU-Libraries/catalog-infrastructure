---
- name: Create AWS config directory
  file:
    path: "/root/.aws"
    state: directory

- name: Create AWS credential file
  copy:
    dest: "/root/.aws/credentials"
    content: "{{ aws_credential_template }}"

- name: Provision catalog server cluster
  community.general.terraform:
    project_path: "../terraform/env/prod/"
    state: present
    provider_upgrade: yes
    # focing init because state file exists in s3 and need provider
    # installed locally before we can detect it
    force_init: yes 
  register: tf

- name: Save outputs to host file
  copy:
    dest: "../configure-playbook/hosts"
    content: |
      catalog_nodes:
        hosts:
          {{ tf.outputs.catalog_a_fqdn.value }}:
            efs_hostname: {{ tf.outputs.catalog_a_efs_hostname.value }}
          {{ tf.outputs.catalog_b_fqdn.value }}:
            efs_hostname: {{ tf.outputs.catalog_b_efs_hostname.value }}
          {{ tf.outputs.catalog_c_fqdn.value }}:
            efs_hostname: {{ tf.outputs.catalog_c_efs_hostname.value }}

- name: Pause for 30 seconds for servers to start and DNS propagate
  ansible.builtin.pause:
    seconds: 30

- name: Add to known hosts file
  ansible.builtin.shell: >
      ssh-keyscan {{ tf.outputs.catalog_a_fqdn.value }} >> ~/.ssh/known_hosts &&
      ssh-keyscan {{ tf.outputs.catalog_b_fqdn.value }} >> ~/.ssh/known_hosts &&
      ssh-keyscan {{ tf.outputs.catalog_c_fqdn.value }} >> ~/.ssh/known_hosts
