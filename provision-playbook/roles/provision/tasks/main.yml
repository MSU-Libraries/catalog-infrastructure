---
- name: Create AWS config directory
  file:
    path: "/root/.aws"
    state: directory

- name: Create AWS credential file
  copy:
    dest: "/root/.aws/credentials"
    content: "{{ aws_credential_template }}"

- name: Provision catalog server cluster
  community.general.terraform:
    project_path: "../terraform/env/prod/"
    state: present
    provider_upgrade: yes
    # focing init because state file exists in s3 and need provider
    # installed locally before we can detect it
    force_init: yes 
  register: tf

- name: Save outputs to host file
  copy:
    dest: "../configure-playbook/hosts"
    content: |
      {{ tf.outputs.catalog_a_fqdn.value }}
      {{ tf.outputs.catalog_b_fqdn.value }}
      {{ tf.outputs.catalog_c_fqdn.value }}

- name: Pause for 20 seconds to start servers
  ansible.builtin.pause:
    seconds: 20

- name: Add to known hosts file
  ansible.builtin.shell: >
      ssh-keyscan {{ tf.outputs.catalog_a_fqdn.value }} >> ~/.ssh/known_hosts &&
      ssh-keyscan {{ tf.outputs.catalog_b_fqdn.value }} >> ~/.ssh/known_hosts &&
      ssh-keyscan {{ tf.outputs.catalog_c_fqdn.value }} >> ~/.ssh/known_hosts
      
  
